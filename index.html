<!DOCTYPE html>
<html lang="id">
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KPPN Digipay Monitoring Sistem</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        min-height: 100vh;
      }

      .sidebar {
        width: 260px;
        background: white;
        height: 100vh;
        position: fixed;
        left: 0;
        top: 0;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        z-index: 100;
      }

      .sidebar-header {
        padding: 25px 20px;
        background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        color: white;
      }

      .sidebar-header h2 {
        font-size: 20px;
        margin-bottom: 5px;
      }
      .sidebar-header p {
        font-size: 13px;
        opacity: 0.9;
      }

      .menu-item {
        padding: 16px 25px;
        display: flex;
        align-items: center;
        gap: 12px;
        color: #64748b;
        cursor: pointer;
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
      }

      .menu-item:hover {
        background: #f8fafc;
        color: #2563eb;
      }

      .menu-item.active {
        background: #eff6ff;
        color: #2563eb;
        border-left-color: #2563eb;
        font-weight: 600;
      }

      .menu-icon {
        font-size: 22px;
      }

      .main-wrapper {
        margin-left: 260px;
        padding: 24px;
      }

      .container {
        max-width: 1600px;
        margin: 0 auto;
      }

      .page-header {
        background: white;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-bottom: 24px;
      }

      .page-header h1 {
        color: #2563eb;
        font-size: 32px;
        margin-bottom: 8px;
      }

      .page-header p {
        color: #64748b;
        font-size: 15px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
      }

      .stat-card {
        background: white;
        padding: 28px;
        border-radius: 16px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      }

      .stat-card h3 {
        color: #64748b;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 12px;
      }

      .stat-card .value {
        font-size: 36px;
        font-weight: bold;
        color: #2563eb;
      }

      .stat-card.green .value {
        color: #10b981;
      }
      .stat-card.amber .value {
        color: #f59e0b;
      }

      .content-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        padding: 30px;
      }

      .toolbar {
        display: flex;
        gap: 15px;
        margin-bottom: 24px;
        flex-wrap: wrap;
      }

      .search-box {
        flex: 1;
        min-width: 250px;
        position: relative;
      }

      .search-icon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
        font-size: 18px;
      }

      .search-box input {
        width: 100%;
        padding: 14px 20px 14px 45px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .search-box input:focus {
        outline: none;
        border-color: #2563eb;
      }

      .btn {
        padding: 14px 24px;
        border: none;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: #2563eb;
        color: white;
      }

      .btn-primary:hover {
        background: #1d4ed8;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3);
      }

      .btn-success {
        background: #10b981;
        color: white;
      }

      .btn-success:hover {
        background: #059669;
      }

      .btn-cancel {
        background: #e2e8f0;
        color: #475569;
      }

      .btn-cancel:hover {
        background: #cbd5e1;
      }

      .btn-icon {
        padding: 10px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s ease;
      }

      .btn-edit {
        background: #3b82f6;
        color: white;
        margin-right: 6px;
      }

      .btn-edit:hover {
        background: #2563eb;
      }

      .btn-delete {
        background: #ef4444;
        color: white;
      }

      .btn-delete:hover {
        background: #dc2626;
      }

      .btn-whatsapp {
        background: #25d366;
        color: white;
      }

      .btn-whatsapp:hover {
        background: #128c7e;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #64748b;
      }

      .error {
        text-align: center;
        padding: 40px;
        color: #ef4444;
      }

      .table-container {
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      thead {
        background: #1e40af;
        color: white;
      }

      th {
        padding: 16px;
        text-align: left;
        font-size: 13px;
        font-weight: 600;
        border: 1px solid #1e3a8a;
        white-space: nowrap;
      }

      td {
        padding: 16px;
        border: 1px solid #e2e8f0;
        font-size: 14px;
        color: #334155;
      }

      tr:hover {
        background: #f8fafc;
      }

      .badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .badge-success {
        background: #d1fae5;
        color: #065f46;
      }

      .badge-danger {
        background: #fee2e2;
        color: #991b1b;
      }

      .badge-warning {
        background: #fef3c7;
        color: #92400e;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: white;
        padding: 32px;
        border-radius: 16px;
        max-width: 700px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }

      .modal-header h2 {
        color: #2563eb;
        font-size: 24px;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 28px;
        color: #64748b;
        cursor: pointer;
        line-height: 1;
      }

      .close-btn:hover {
        color: #334155;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #475569;
        font-weight: 600;
        font-size: 14px;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 14px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 14px;
        transition: border-color 0.3s ease;
      }

      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: #2563eb;
      }

      .form-group textarea {
        min-height: 120px;
        resize: vertical;
      }

      .form-group input[readonly],
      .form-group textarea[readonly] {
        background: #f8fafc;
      }

      /* Autocomplete Styles */
      .autocomplete-container {
        position: relative;
      }

      .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 200px;
        overflow-y: auto;
        background: white;
        border: 2px solid #2563eb;
        border-top: none;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 10000;
        display: none;
      }

      .autocomplete-dropdown.active {
        display: block;
      }

      .autocomplete-item {
        padding: 12px 16px;
        cursor: pointer;
        transition: background 0.2s;
        border-bottom: 1px solid #e2e8f0;
      }

      .autocomplete-item:hover {
        background: #eff6ff;
      }

      .autocomplete-item:last-child {
        border-bottom: none;
      }

      .autocomplete-item .code {
        font-weight: 600;
        color: #2563eb;
        margin-bottom: 4px;
      }

      .autocomplete-item .name {
        font-size: 13px;
        color: #64748b;
      }

      .modal-actions {
        display: flex;
        gap: 12px;
        margin-top: 24px;
      }

      .modal-actions .btn {
        flex: 1;
      }

      .page-content {
        display: none;
      }

      .page-content.active {
        display: block;
      }

      select {
        padding: 14px 20px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 14px;
        background: white;
        cursor: pointer;
      }

      select:focus {
        outline: none;
        border-color: #2563eb;
      }

      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
        }
        .main-wrapper {
          margin-left: 0;
        }
        .form-row {
          grid-template-columns: 1fr;
        }
      }
      .btn-print {
        background: #8b5cf6;
        color: white;
      }

      .btn-print:hover {
        background: #7c3aed;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(139, 92, 246, 0.3);
      }

      @media print {
        .toolbar,
        .btn {
          display: none;
        }
      }
      .form-group input[readonly],
      .form-group textarea[readonly] {
        background: #f8fafc;
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <div class="sidebar-header">
        <h2>KPPN Sistem</h2>
        <p>Digipay Monitoring</p>
      </div>
      <div class="sidebar-menu">
        <div class="menu-item active" data-page="dashboard">
          <span class="menu-icon"></span>
          <span>Dashboard</span>
        </div>
        <div class="menu-item" data-page="data-transaksi">
          <span class="menu-icon"></span>
          <span>Data Transaksi</span>
        </div>
        <div class="menu-item" data-page="sheet-proses">
          <span class="menu-icon"></span>
          <span>Proses</span>
        </div>
        <div class="menu-item" data-page="rekap-digipay">
          <span class="menu-icon"></span>
          <span>Rekap Digipay</span>
        </div>
      </div>
    </div>

    <div class="main-wrapper">
      <div class="container">
        <div id="dashboard" class="page-content active">
          <div class="page-header">
            <h1>Dashboard Satker</h1>
            <p>Data Satker KPPN Pekalongan</p>
          </div>

          <div class="stats-grid">
            <div class="stat-card">
              <h3>Total Satker</h3>
              <div class="value" id="totalSatker">0</div>
            </div>
            <div class="stat-card green">
              <h3>Sudah Implementasi</h3>
              <div class="value" id="sudahImplement">0</div>
            </div>
            <div class="stat-card amber">
              <h3>Belum Implementasi</h3>
              <div class="value" id="belumImplement">0</div>
            </div>
            <div class="stat-card">
              <h3>Total Transaksi</h3>
              <div class="value" id="totalTransaksi">0</div>
            </div>
          </div>

          <div class="content-card">
            <div class="toolbar">
              <div class="search-box">
                <span class="search-icon"></span>
                <input
                  type="text"
                  id="searchDashboard"
                  placeholder="Cari satker..."
                />
              </div>
              <button class="btn btn-primary" id="btnAddDashboard">
                <span>+</span> Tambah Satker
              </button>
              <button
                class="btn btn-success"
                onclick="app.showImportModal('satker')"
              >
                <span>üì•</span> Import Excel
              </button>
            </div>

            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>No</th>
                    <th>Kode Satker</th>
                    <th>Satker</th>
                    <th>Nominal</th>
                    <th>Nomor WA</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody id="dashboardTableBody">
                  <tr>
                    <td colspan="6" class="loading">Memuat data...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="data-transaksi" class="page-content">
          <div class="page-header">
            <h1>Data Transaksi</h1>
            <p>Kelola Data Transaksi Digipay Lengkap</p>
          </div>

          <div class="content-card">
            <div class="toolbar">
              <div class="search-box">
                <span class="search-icon"></span>
                <input type="text" id="searchTransaksi" placeholder="Cari..." />
              </div>
              <button class="btn btn-primary" id="btnAddTransaksi">
                <span>+</span> Tambah Transaksi
              </button>
              <button
                class="btn btn-success"
                onclick="app.showImportModal('transaksi')"
              >
                <span>üì•</span> Import Excel
              </button>
            </div>

            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>No</th>
                    <th>Tanggal Pembelian</th>
                    <th>KPPN</th>
                    <th>Satuan Kerja</th>
                    <th>Pejabat Pengadaan</th>
                    <th>Produk</th>
                    <th>Total Nominal</th>
                    <th>No Rekening</th>
                    <th>No Invoice</th>
                    <th>Metode Bayar</th>
                    <th>Status Transaksi</th>
                    <th>Tgl Deadline</th>
                    <th>Tgl Jatuh Tempo</th>
                    <th>Tgl Checkout</th>
                    <th>Tgl Kirim</th>
                    <th>Tgl Terima</th>
                    <th>Tgl Bayar</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody id="transaksiTableBody">
                  <tr>
                    <td colspan="18" class="loading">Memuat data...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="sheet-proses" class="page-content">
          <div class="page-header">
            <h1>Proses</h1>
          </div>

          <div class="content-card">
            <div class="toolbar">
              <div class="search-box">
                <span class="search-icon"></span>
                <input type="text" id="searchProses" placeholder="Cari..." />
              </div>
              <select id="statusFilter">
                <option value="">Semua Status</option>
                <option value="SUDAH">Sudah</option>
                <option value="BELUM">Belum</option>
              </select>
              <!-- TAMBAHKAN BARIS INI -->
              <button class="btn btn-print" onclick="app.printProses()">
                <span>üñ®Ô∏è</span> Cetak PDF
              </button>
              <button class="btn btn-success" onclick="app.exportProsesExcel()">
                <span>üìä</span> Export Excel
              </button>
            </div>

            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Kode</th>
                    <th>Nama Satker</th>
                    <th>Status</th>
                    <th>Proses Transaksi</th>
                    <th>Transaksi</th>
                    <th>VA Terbayar</th>
                  </tr>
                </thead>
                <tbody id="prosesTableBody">
                  <tr>
                    <td colspan="6" class="loading">Memuat data...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="rekap-digipay" class="page-content">
          <div class="page-header">
            <h1>Rekap Digipay</h1>
            <p>Monitoring Digipay Satuan Kerja KPPN Pekalongan</p>
          </div>

          <div class="content-card">
            <div class="toolbar">
              <div class="search-box">
                <span class="search-icon"></span>
                <input type="text" id="searchRekap" placeholder="Cari..." />
              </div>
              <select id="statusFilterRekap">
                <option value="">Semua Status</option>
                <option value="SUDAH">Sudah</option>
                <option value="BELUM">Belum</option>
              </select>
              <!-- TAMBAHKAN BARIS INI -->
              <button class="btn btn-print" onclick="app.printRekap()">
                <span>üñ®Ô∏è</span> Cetak PDF
              </button>
              <button class="btn btn-success" onclick="app.exportRekapExcel()">
                <span>üìä</span> Export Excel
              </button>
            </div>

            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>No</th>
                    <th>Kode Satker</th>
                    <th>Satker</th>
                    <th>Nominal</th>
                    <th>Proses Transaksi</th>
                    <th>VA Terbayar</th>
                    <th>Transaksi VA</th>
                    <th>Status</th>
                    <th>Keterangan</th>
                  </tr>
                </thead>
                <tbody id="rekapTableBody">
                  <tr>
                    <td colspan="9" class="loading">Memuat data...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="dashboardModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="dashboardModalTitle">Tambah Data Satker</h2>
          <button class="close-btn" id="closeDashboardModal">√ó</button>
        </div>
        <form id="dashboardForm">
          <div class="form-group">
            <label>Kode Satker</label>
            <input type="text" id="kodeSatkerDash" required />
          </div>
          <div class="form-group">
            <label>Nama Satker</label>
            <input type="text" id="namaSatkerDash" required />
          </div>
          <div class="form-group">
            <label>Nominal</label>
            <input type="number" id="upRM" value="0" />
          </div>
          <div class="form-group">
            <label>Nomor WhatsApp</label>
            <input type="tel" id="nomorWA" placeholder="628123456789" />
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-cancel" id="cancelDashboard">
              Batal
            </button>
            <button type="submit" class="btn btn-primary">Simpan</button>
          </div>
        </form>
      </div>
    </div>
    xx
    <div id="transaksiModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="transaksiModalTitle">Tambah Data Transaksi</h2>
          <button class="close-btn" id="closeTransaksiModal">√ó</button>
        </div>
        <form id="transaksiForm">
          <div class="form-row">
            <div class="form-group">
              <label>Tanggal Pembelian</label>
              <input type="date" id="tglPembelian" required />
            </div>
            <div class="form-group">
              <label>KPPN</label>
              <input
                type="text"
                id="kppn"
                value="KPPN PEKALONGAN"
                placeholder="KPPN PEKALONGAN"
                required
                readonly
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group autocomplete-container">
              <label>Kode Satker</label>
              <input
                type="text"
                id="kodeSatker"
                required
                autocomplete="off"
                placeholder="Ketik atau pilih kode satker..."
              />
              <div id="kodeSatkerDropdown" class="autocomplete-dropdown"></div>
            </div>
            <div class="form-group">
              <label>Satuan Kerja</label>
              <input type="text" id="satker" required readonly />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Pejabat Pengadaan</label>
              <input type="text" id="pejabat" required />
            </div>
            <div class="form-group">
              <label>Produk</label>
              <input type="text" id="produk" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Total Nominal</label>
              <input type="number" id="totalNominal" required />
            </div>
            <div class="form-group">
              <label>No Rekening</label>
              <input type="text" id="noRekening" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>No Invoice</label>
              <input type="text" id="noInvoice" required />
            </div>
            <div class="form-group">
              <label>Metode Bayar</label>
              <select id="metodeBayar">
                <option value="VA">VA</option>
                <option value="Transfer">Transfer</option>
                <option value="Tunai">Tunai</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Status Transaksi</label>
              <select id="statusTransaksi">
                <option value="Pending">Pending</option>
                <option value="Berhasil">Berhasil</option>
                <option value="Gagal">Gagal</option>
              </select>
            </div>
            <div class="form-group">
              <label>Tanggal Deadline</label>
              <input type="date" id="tglDeadline" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Tanggal Jatuh Tempo</label>
              <input type="date" id="tglJatuhTempo" />
            </div>
            <div class="form-group">
              <label>Tanggal Checkout</label>
              <input type="date" id="tglCheckout" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Tanggal Kirim</label>
              <input type="date" id="tglKirim" />
            </div>
            <div class="form-group">
              <label>Tanggal Terima</label>
              <input type="date" id="tglTerima" />
            </div>
          </div>
          <div class="form-group">
            <label>Tanggal Bayar</label>
            <input type="date" id="tglBayar" />
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-cancel" id="cancelTransaksi">
              Batal
            </button>
            <button type="submit" class="btn btn-primary">Simpan</button>
          </div>
        </form>
      </div>
    </div>

    <div id="whatsappModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Kirim Notifikasi WhatsApp</h2>
          <button class="close-btn" id="closeWhatsappModal">√ó</button>
        </div>
        <form id="whatsappForm">
          <div class="form-group">
            <label>Nama Satker</label>
            <input type="text" id="waSatkerName" readonly />
          </div>
          <div class="form-group">
            <label>Nomor WhatsApp</label>
            <input type="tel" id="waNumber" required />
          </div>
          <div class="form-group">
            <label>Pesan</label>
            <textarea id="waMessage" readonly></textarea>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-cancel" id="cancelWhatsapp">
              Batal
            </button>
            <button type="submit" class="btn btn-success">
              <span></span> Kirim WhatsApp
            </button>
          </div>
        </form>
      </div>
    </div>
    <!-- Modal Import Excel -->
    <div id="importModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="importModalTitle">Import Data dari Excel</h2>
          <button class="close-btn" id="closeImportModal">√ó</button>
        </div>
        <div style="margin-bottom: 20px">
          <p style="color: #64748b; margin-bottom: 15px">
            <strong>Format Excel yang dibutuhkan:</strong>
          </p>
          <div
            id="importInstructions"
            style="
              background: #f8fafc;
              padding: 15px;
              border-radius: 8px;
              font-size: 13px;
            "
          >
            <!-- Instruksi akan diisi dinamis -->
          </div>
        </div>
        <div class="form-group">
          <label>Pilih File Excel (.xlsx atau .xls)</label>
          <input
            type="file"
            id="excelFile"
            accept=".xlsx,.xls"
            style="
              padding: 10px;
              border: 2px dashed #2563eb;
              background: #eff6ff;
            "
          />
        </div>
        <div id="previewContainer" style="display: none; margin-top: 20px">
          <h3 style="color: #2563eb; margin-bottom: 10px">
            Preview Data (5 baris pertama)
          </h3>
          <div style="max-height: 300px; overflow: auto">
            <table id="previewTable" style="width: 100%; font-size: 12px">
              <!-- Preview akan diisi di sini -->
            </table>
          </div>
          <p
            id="previewInfo"
            style="margin-top: 10px; color: #64748b; font-size: 13px"
          ></p>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-cancel" id="cancelImport">
            Batal
          </button>
          <button
            type="button"
            class="btn btn-primary"
            id="btnProcessImport"
            disabled
          >
            <span>‚¨ÜÔ∏è</span> Proses Import
          </button>
        </div>
      </div>
    </div>

    <script>
      const SUPABASE_URL = "https://tpmmpzsujmhadmsaynsa.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRwbW1wenN1am1oYWRtc2F5bnNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2MzQ0NDcsImV4cCI6MjA3NTIxMDQ0N30.x91ksouGDFhe7MiRFEMD-geLHHMgK1VkrNzzIlda9YI";

      const { createClient } = supabase;
      const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

      const app = {
        activePage: "dashboard",
        currentEdit: null,
        dashboardData: [],
        transaksiData: [],
        sheetProsesData: [],
        rekapDigipayData: [],

        async init() {
          console.log("Inisialisasi aplikasi...");
          try {
            await this.loadDashboardData();
            await this.loadTransaksiData();
            this.calculateSheetProses();
            this.calculateRekapDigipay();
            this.renderAll();
            this.updateStats();
            this.setupEventListeners();
            console.log("Aplikasi berhasil diinisialisasi");
          } catch (error) {
            console.error("Error saat inisialisasi:", error);
          }
        },

        async loadDashboardData() {
          try {
            console.log("Memuat data satker...");
            const { data, error } = await supabaseClient
              .from("tbl_satker")
              .select("*")
              .order("id_satker");

            if (error) throw error;

            this.dashboardData = data || [];
            console.log(
              `‚úì Berhasil memuat ${this.dashboardData.length} data satker`
            );
          } catch (err) {
            console.error("Error loading satker:", err);
            document.getElementById("dashboardTableBody").innerHTML =
              '<tr><td colspan="6" class="error">Gagal memuat data: ' +
              err.message +
              "</td></tr>";
          }
        },

        async loadTransaksiData() {
          try {
            console.log("Memuat data transaksi...");
            let allData = [];
            let page = 0;
            const pageSize = 1000;

            while (true) {
              const { data, error } = await supabaseClient
                .from("tbl_transaksi")
                .select("*")
                .order("no")
                .range(page * pageSize, (page + 1) * pageSize - 1);

              if (error) throw error;
              if (!data || data.length === 0) break;

              allData = allData.concat(data);
              page++;
            }

            this.transaksiData = allData;
            console.log(
              `‚úì Berhasil memuat ${this.transaksiData.length} data transaksi`
            );
          } catch (err) {
            console.error("Error loading transaksi:", err);
          }
        },
        setupEventListeners() {
          document.querySelectorAll(".menu-item").forEach((item) => {
            item.addEventListener("click", (e) => {
              const page = e.currentTarget.getAttribute("data-page");
              this.changePage(page);
            });
          });

          document
            .getElementById("btnAddDashboard")
            .addEventListener("click", () => this.openModal("dashboard"));
          document
            .getElementById("btnAddTransaksi")
            .addEventListener("click", () => this.openModal("transaksi"));

          document
            .getElementById("closeDashboardModal")
            .addEventListener("click", () => this.closeModal("dashboard"));
          document
            .getElementById("closeTransaksiModal")
            .addEventListener("click", () => this.closeModal("transaksi"));
          document
            .getElementById("closeWhatsappModal")
            .addEventListener("click", () => this.closeModal("whatsapp"));

          document
            .getElementById("cancelDashboard")
            .addEventListener("click", () => this.closeModal("dashboard"));
          document
            .getElementById("cancelTransaksi")
            .addEventListener("click", () => this.closeModal("transaksi"));
          document
            .getElementById("cancelWhatsapp")
            .addEventListener("click", () => this.closeModal("whatsapp"));

          // Event listeners untuk import
          document
            .getElementById("closeImportModal")
            .addEventListener("click", () => this.closeModal("import"));
          document
            .getElementById("cancelImport")
            .addEventListener("click", () => this.closeModal("import"));
          document
            .getElementById("excelFile")
            .addEventListener("change", () => this.previewImport());
          document
            .getElementById("btnProcessImport")
            .addEventListener("click", () => this.processImport());

          document
            .getElementById("dashboardForm")
            .addEventListener("submit", (e) => this.saveDashboard(e));
          document
            .getElementById("transaksiForm")
            .addEventListener("submit", (e) => this.saveTransaksi(e));
          document
            .getElementById("whatsappForm")
            .addEventListener("submit", (e) => this.sendWhatsApp(e));

          document
            .getElementById("searchDashboard")
            .addEventListener("input", () => this.searchData());
          document
            .getElementById("searchTransaksi")
            .addEventListener("input", () => this.searchData());
          document
            .getElementById("searchProses")
            .addEventListener("input", () => this.searchData());
          document
            .getElementById("searchRekap")
            .addEventListener("input", () => this.searchData());
          document
            .getElementById("statusFilter")
            .addEventListener("change", () => this.searchData());
          document
            .getElementById("statusFilterRekap")
            .addEventListener("change", () => this.searchData());
        },

        setupKodeSatkerAutocomplete() {
          const input = document.getElementById("kodeSatker");
          const dropdown = document.getElementById("kodeSatkerDropdown");
          const satkerInput = document.getElementById("satker");

          // Hapus event listener lama dengan clone node
          const newInput = input.cloneNode(true);
          input.parentNode.replaceChild(newInput, input);

          // Update reference ke input baru
          const kodeSatkerInput = document.getElementById("kodeSatker");

          // Event saat user mengetik
          kodeSatkerInput.addEventListener("input", (e) => {
            const value = e.target.value.toLowerCase();

            if (value.length === 0) {
              dropdown.classList.remove("active");
              satkerInput.value = "";
              return;
            }

            // Filter data satker
            const filtered = this.dashboardData.filter(
              (d) =>
                d.kode_satker.toLowerCase().includes(value) ||
                d.nama_satker.toLowerCase().includes(value)
            );

            if (filtered.length > 0) {
              dropdown.innerHTML = filtered
                .map(
                  (d) => `
                <div class="autocomplete-item" data-kode="${d.kode_satker}" data-nama="${d.nama_satker}">
                    <div class="code">${d.kode_satker}</div>
                    <div class="name">${d.nama_satker}</div>
                </div>
            `
                )
                .join("");
              dropdown.classList.add("active");

              // Event click pada item dropdown
              dropdown
                .querySelectorAll(".autocomplete-item")
                .forEach((item) => {
                  item.addEventListener("click", (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    kodeSatkerInput.value = item.dataset.kode;
                    satkerInput.value = item.dataset.nama;
                    dropdown.classList.remove("active");
                  });
                });
            } else {
              dropdown.innerHTML =
                '<div style="padding: 12px; color: #64748b; text-align: center;">Tidak ada data</div>';
              dropdown.classList.add("active");
            }
          });

          // Event focus - tampilkan semua opsi
          kodeSatkerInput.addEventListener("focus", () => {
            if (kodeSatkerInput.value.length === 0) {
              dropdown.innerHTML = this.dashboardData
                .map(
                  (d) => `
                <div class="autocomplete-item" data-kode="${d.kode_satker}" data-nama="${d.nama_satker}">
                    <div class="code">${d.kode_satker}</div>
                    <div class="name">${d.nama_satker}</div>
                </div>
            `
                )
                .join("");
              dropdown.classList.add("active");

              dropdown
                .querySelectorAll(".autocomplete-item")
                .forEach((item) => {
                  item.addEventListener("click", (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    kodeSatkerInput.value = item.dataset.kode;
                    satkerInput.value = item.dataset.nama;
                    dropdown.classList.remove("active");
                  });
                });
            }
          });

          // Tutup dropdown saat klik di luar
          document.addEventListener("click", (e) => {
            if (
              !kodeSatkerInput.contains(e.target) &&
              !dropdown.contains(e.target)
            ) {
              dropdown.classList.remove("active");
            }
          });

          // Event saat input kehilangan focus
          kodeSatkerInput.addEventListener("blur", () => {
            setTimeout(() => {
              const satker = this.dashboardData.find(
                (d) => d.kode_satker === kodeSatkerInput.value
              );
              if (satker) {
                satkerInput.value = satker.nama_satker;
              } else if (kodeSatkerInput.value && !satkerInput.value) {
                alert(
                  "Kode Satker tidak ditemukan! Silakan pilih dari daftar."
                );
                kodeSatkerInput.value = "";
              }
            }, 300);
          });
        },

        changePage(pageId) {
          this.activePage = pageId;

          document.querySelectorAll(".menu-item").forEach((item) => {
            item.classList.remove("active");
            if (item.getAttribute("data-page") === pageId) {
              item.classList.add("active");
            }
          });

          document.querySelectorAll(".page-content").forEach((page) => {
            page.classList.remove("active");
          });
          document.getElementById(pageId).classList.add("active");

          this.clearSearch();
          this.renderCurrentPage();
        },

       calculateSheetProses() {
    const grouped = {};
    
    // LANGKAH 1: Inisialisasi SEMUA satker dari dashboard dengan nilai 0
    this.dashboardData.forEach(satker => {
        grouped[satker.kode_satker] = {
            kodeSatker: satker.kode_satker,
            namaSatker: satker.nama_satker,
            totalData: 0,
            jumlahTransaksi: 0,
            vaTerbayar: 0
        };
    });
    
    // LANGKAH 2: Hitung transaksi untuk satker yang ada transaksinya
    this.transaksiData.forEach(trx => {
        if (grouped[trx.kode_satker]) {
            grouped[trx.kode_satker].totalData++;
            
            // Hitung transaksi yang sudah dibayar (invoice & tanggal bayar terisi)
            if (trx.nomor_invoice && trx.tanggal_bayar) {
                grouped[trx.kode_satker].jumlahTransaksi++;
            }

            // Hitung VA terbayar (metode VA + tanggal bayar terisi)
            if (trx.metode_bayar === 'VA' && trx.tanggal_bayar) {
                grouped[trx.kode_satker].vaTerbayar++;
            }
        }
    });
    
    // LANGKAH 3: Konversi ke array dengan status
    this.sheetProsesData = Object.values(grouped).map(item => ({
        kodeSatker: item.kodeSatker,
        namaSatker: item.namaSatker,
        status: item.vaTerbayar > 0 ? 'SUDAH' : 'BELUM',
        prosesTransaksi: item.totalData,
        transaksi: item.jumlahTransaksi,
        vaTerbayar: item.vaTerbayar
    }));
},

        calculateRekapDigipay() {
    const grouped = {};
    
    // LANGKAH 1: Inisialisasi SEMUA satker dari dashboard
    this.dashboardData.forEach(satker => {
        grouped[satker.kode_satker] = {
            kodeSatker: satker.kode_satker,
            namaSatker: satker.nama_satker,
            upRM: satker.nominal || 0,
            prosesTransaksi: 0,
            vaTerbayar: 0,
            transaksiKuitansi: 0
        };
    });
    
    // LANGKAH 2: Hitung transaksi untuk satker yang ada transaksinya
    this.transaksiData.forEach(trx => {
        if (grouped[trx.kode_satker]) {
            // Hitung semua proses transaksi
            grouped[trx.kode_satker].prosesTransaksi++;

            // Hitung transaksi terbayar (invoice & tanggal bayar terisi)
            if (trx.nomor_invoice && trx.tanggal_bayar) {
                grouped[trx.kode_satker].transaksiKuitansi++;
            }

            // Hitung VA terbayar (metode VA + tanggal bayar terisi)
            if (trx.metode_bayar === 'VA' && trx.tanggal_bayar) {
                grouped[trx.kode_satker].vaTerbayar++;
            }
        }
    });
    
    // LANGKAH 3: Konversi ke array final
    this.rekapDigipayData = Object.values(grouped).map((item, index) => {
        const status = item.vaTerbayar > 0 ? 'SUDAH' : 'BELUM';
        let keterangan = '';
        
        if (status === 'BELUM') {
            keterangan = 'Belum menggunakan Digipay';
        }
        
        return {
            no: index + 1,
            kodeSatker: item.kodeSatker,
            namaSatker: item.namaSatker,
            upRM: item.upRM,
            prosesTransaksi: item.prosesTransaksi,
            vaTerbayar: item.vaTerbayar,
            transaksiKuitansi: item.transaksiKuitansi,
            status: status,
            keterangan: keterangan
        };
    });
},

        updateStats() {
          document.getElementById("totalSatker").textContent =
            this.dashboardData.length;
          document.getElementById("sudahImplement").textContent =
            this.sheetProsesData.filter((s) => s.status === "SUDAH").length;
          document.getElementById("belumImplement").textContent =
            this.sheetProsesData.filter((s) => s.status === "BELUM").length;
          document.getElementById("totalTransaksi").textContent =
            this.transaksiData.length;
        },

        renderAll() {
          this.renderDashboardTable();
          this.renderTransaksiTable();
          this.renderProsesTable();
          this.renderRekapTable();
        },

        renderCurrentPage() {
          if (this.activePage === "dashboard") this.renderDashboardTable();
          else if (this.activePage === "data-transaksi")
            this.renderTransaksiTable();
          else if (this.activePage === "sheet-proses") this.renderProsesTable();
          else if (this.activePage === "rekap-digipay") this.renderRekapTable();
        },

        renderDashboardTable() {
          const tbody = document.getElementById("dashboardTableBody");
          const data = this.getFilteredData();

          if (data.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="6" class="loading">Tidak ada data</td></tr>';
            return;
          }

          tbody.innerHTML = data
            .map(
              (d, index) => `
    <tr>
        <td>${index + 1}</td>
        <td>${d.kode_satker || "-"}</td>
        <td>${d.nama_satker || "-"}</td>
        <td>Rp ${(d.nominal || 0).toLocaleString("id-ID")}</td>
        <td>${d.nomor_wa || "-"}</td>
        <td>
            <button class="btn-icon btn-edit" onclick="app.editDashboard('${
              d.kode_satker
            }')">edit</button>
            <button class="btn-icon btn-whatsapp" onclick="app.prepareWhatsApp('${
              d.kode_satker
            }')">notif</button>
        </td>
    </tr>
`
            )
            .join("");
        },

        renderTransaksiTable() {
          const tbody = document.getElementById("transaksiTableBody");
          const data = this.getFilteredData();

          if (data.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="18" class="loading">Tidak ada data</td></tr>';
            return;
          }

          tbody.innerHTML = data
            .map(
              (t, index) => `
                    <tr>
                        <td>${index + 1 || "-"}</td>
                        <td>${t.tanggal_pembelian || "-"}</td>
                        <td>${t.kppn || "-"}</td>
                        <td>${t.satuan_kerja || "-"}</td>
                        <td>${t.pejabat_pengadaan || "-"}</td>
                        <td>${t.produk || "-"}</td>
                        <td>Rp ${(t.total_nominal || 0).toLocaleString(
                          "id-ID"
                        )}</td>
                        <td>${t.nomor_rekening || "-"}</td>
                        <td>${t.nomor_invoice || "-"}</td>
                        <td>${t.metode_bayar || "-"}</td>
                        <td>
                            <span class="badge ${
                              t.status_transaksi === "Berhasil"
                                ? "badge-success"
                                : t.status_transaksi === "Pending"
                                ? "badge-warning"
                                : "badge-danger"
                            }">
                                ${t.status_transaksi || "Pending"}
                            </span>
                        </td>
                        <td>${t.tanggal_deadline || "-"}</td>
                        <td>${t.tanggal_jatuh_tempo || "-"}</td>
                        <td>${t.tanggal_checkout || "-"}</td>
                        <td>${t.tanggal_kirim || "-"}</td>
                        <td>${t.tanggal_terima || "-"}</td>
                        <td>${t.tanggal_bayar || "-"}</td>
                        <td>
                            <button class="btn-icon btn-edit" onclick="app.editTransaksi(${
                              t.no
                            })">edit</button>
                            <button class="btn-icon btn-delete" onclick="app.deleteTransaksi(${
                              t.no
                            })">hapus</button>
                        </td>
                    </tr>
                `
            )
            .join("");
        },

        renderProsesTable() {
          const tbody = document.getElementById("prosesTableBody");
          const data = this.getFilteredData();

          if (data.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="6" class="loading">Tidak ada data</td></tr>';
            return;
          }

          tbody.innerHTML = data
            .map(
              (p) => `
                    <tr>
                        <td>${p.kodeSatker}</td>
                        <td>${p.namaSatker}</td>
                        <td>
                            <span class="badge ${
                              p.status === "SUDAH"
                                ? "badge-success"
                                : "badge-danger"
                            }">
                                ${p.status}
                            </span>
                        </td>
                        <td>${p.prosesTransaksi}</td>
                        <td>${p.transaksi}</td>
                        <td>${p.vaTerbayar}</td>
                    </tr>
                `
            )
            .join("");
        },

        renderRekapTable() {
          const tbody = document.getElementById("rekapTableBody");
          const data = this.getFilteredData();

          if (data.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="9" class="loading">Tidak ada data</td></tr>';
            return;
          }

          tbody.innerHTML = data
            .map(
              (r) => `
                    <tr>
                        <td>${r.no}</td>
                        <td>${r.kodeSatker}</td>
                        <td>${r.namaSatker}</td>
                        <td>Rp ${(r.upRM || 0).toLocaleString("id-ID")}</td>
                        <td>${r.prosesTransaksi}</td>
                        <td>${r.vaTerbayar}</td>
                        <td>${r.transaksiKuitansi}</td>
                        <td>
                            <span class="badge ${
                              r.status === "SUDAH"
                                ? "badge-success"
                                : "badge-danger"
                            }">
                                ${r.status}
                            </span>
                        </td>
                        <td>${r.keterangan}</td>
                    </tr>
                `
            )
            .join("");
        },

        getFilteredData() {
          const searchInput =
            this.activePage === "dashboard"
              ? "searchDashboard"
              : this.activePage === "data-transaksi"
              ? "searchTransaksi"
              : this.activePage === "rekap-digipay"
              ? "searchRekap"
              : "searchProses";
          const searchTerm =
            document.getElementById(searchInput)?.value.toLowerCase() || "";

          if (this.activePage === "dashboard") {
            return this.dashboardData.filter(
              (d) =>
                (d.kode_satker || "").toLowerCase().includes(searchTerm) ||
                (d.nama_satker || "").toLowerCase().includes(searchTerm)
            );
          }

          if (this.activePage === "data-transaksi") {
            return this.transaksiData.filter(
              (t) =>
                (t.kode_satker || "").toLowerCase().includes(searchTerm) ||
                (t.satuan_kerja || "").toLowerCase().includes(searchTerm) ||
                (t.pejabat_pengadaan || "")
                  .toLowerCase()
                  .includes(searchTerm) ||
                (t.nomor_invoice || "").toLowerCase().includes(searchTerm) ||
                (t.kppn || "").toLowerCase().includes(searchTerm)
            );
          }

          if (this.activePage === "sheet-proses") {
            const statusFilter = document.getElementById("statusFilter").value;
            return this.sheetProsesData.filter((p) => {
              const matchSearch =
                (p.kodeSatker || "").toLowerCase().includes(searchTerm) ||
                (p.namaSatker || "").toLowerCase().includes(searchTerm);
              const matchStatus = !statusFilter || p.status === statusFilter;
              return matchSearch && matchStatus;
            });
          }

          if (this.activePage === "rekap-digipay") {
            const statusFilter =
              document.getElementById("statusFilterRekap").value;
            return this.rekapDigipayData.filter((r) => {
              const matchSearch =
                (r.kodeSatker || "").toLowerCase().includes(searchTerm) ||
                (r.namaSatker || "").toLowerCase().includes(searchTerm);
              const matchStatus = !statusFilter || r.status === statusFilter;
              return matchSearch && matchStatus;
            });
          }

          return [];
        },

        searchData() {
          this.renderCurrentPage();
        },

        clearSearch() {
          const inputs = [
            "searchDashboard",
            "searchTransaksi",
            "searchProses",
            "searchRekap",
          ];
          inputs.forEach((id) => {
            const el = document.getElementById(id);
            if (el) el.value = "";
          });
          if (document.getElementById("statusFilter")) {
            document.getElementById("statusFilter").value = "";
          }
          if (document.getElementById("statusFilterRekap")) {
            document.getElementById("statusFilterRekap").value = "";
          }
        },

        openModal(type, data = null) {
          this.currentEdit = data;

          if (type === "dashboard") {
            document.getElementById("dashboardModalTitle").textContent = data
              ? "Edit Data Satker"
              : "Tambah Data Satker";

            const kodeSatkerInput = document.getElementById("kodeSatkerDash");
            kodeSatkerInput.value = data?.kode_satker || "";

            if (data) {
              kodeSatkerInput.setAttribute("readonly", "readonly");
              kodeSatkerInput.style.background = "#f8fafc";
            } else {
              kodeSatkerInput.removeAttribute("readonly");
              kodeSatkerInput.style.background = "white";
            }

            document.getElementById("namaSatkerDash").value =
              data?.nama_satker || "";
            document.getElementById("upRM").value = data?.nominal || 0;
            document.getElementById("nomorWA").value = data?.nomor_wa || "";
            document.getElementById("dashboardModal").classList.add("active");
          } else if (type === "transaksi") {
            document.getElementById("transaksiModalTitle").textContent = data
              ? "Edit Data Transaksi"
              : "Tambah Data Transaksi";
            document.getElementById("kppn").value = "KPPN PEKALONGAN";
            document.getElementById("tglPembelian").value =
              data?.tanggal_pembelian || "";
            document.getElementById("kppn").value =
              data?.kppn || "KPPN PEKALONGAN";
            document.getElementById("kodeSatker").value =
              data?.kode_satker || "";
            document.getElementById("satker").value = data?.satuan_kerja || "";
            document.getElementById("pejabat").value =
              data?.pejabat_pengadaan || "";
            document.getElementById("produk").value = data?.produk || "";
            document.getElementById("totalNominal").value =
              data?.total_nominal || "";
            document.getElementById("noRekening").value =
              data?.nomor_rekening || "";
            document.getElementById("noInvoice").value =
              data?.nomor_invoice || "";
            document.getElementById("metodeBayar").value =
              data?.metode_bayar || "VA";
            document.getElementById("statusTransaksi").value =
              data?.status_transaksi || "Pending";
            document.getElementById("tglDeadline").value =
              data?.tanggal_deadline || "";
            document.getElementById("tglJatuhTempo").value =
              data?.tanggal_jatuh_tempo || "";
            document.getElementById("tglCheckout").value =
              data?.tanggal_checkout || "";
            document.getElementById("tglKirim").value =
              data?.tanggal_kirim || "";
            document.getElementById("tglTerima").value =
              data?.tanggal_terima || "";
            document.getElementById("tglBayar").value =
              data?.tanggal_bayar || "";
            this.setupKodeSatkerAutocomplete();
            document.getElementById("transaksiModal").classList.add("active");
          }
        },

        closeModal(type) {
          const modals = {
            dashboard: "dashboardModal",
            transaksi: "transaksiModal",
            whatsapp: "whatsappModal",
            import: "importModal",
          };
          document.getElementById(modals[type]).classList.remove("active");
          this.currentEdit = null;
        },
        async saveDashboard(event) {
          event.preventDefault();

          const data = {
            kode_satker: document.getElementById("kodeSatkerDash").value,
            nama_satker: document.getElementById("namaSatkerDash").value,
            nominal: parseFloat(document.getElementById("upRM").value) || 0,
            nomor_wa: document.getElementById("nomorWA").value,
          };

          try {
            if (this.currentEdit) {
              console.log("Updating satker:", data);
              const { error } = await supabaseClient
                .from("tbl_satker")
                .update(data)
                .eq("kode_satker", this.currentEdit.kode_satker);

              if (error) {
                console.error("Update error:", error);
                throw error;
              }

              console.log("Update successful");
            } else {
              console.log("Checking for duplicate kode_satker...");
              const { data: existing, error: checkError } = await supabaseClient
                .from("tbl_satker")
                .select("kode_satker")
                .eq("kode_satker", data.kode_satker)
                .maybeSingle();

              if (checkError) {
                console.error("Check error:", checkError);
                throw checkError;
              }

              if (existing) {
                alert(
                  'Kode Satker "' +
                    data.kode_satker +
                    '" sudah ada! Gunakan kode yang berbeda.'
                );
                return;
              }

              // Insert data baru
              console.log("Inserting new satker:", data);
              const { error } = await supabaseClient
                .from("tbl_satker")
                .insert([data]);

              if (error) {
                console.error("Insert error:", error);
                throw error;
              }

              console.log("Insert successful");
            }

            await this.loadDashboardData();
            this.calculateSheetProses();
            this.calculateRekapDigipay();
            this.renderAll();
            this.updateStats();
            this.closeModal("dashboard");

            const message = this.currentEdit ? "diperbarui" : "ditambahkan";
            alert("Data satker berhasil " + message + "!");
          } catch (err) {
            console.error("Error saving satker:", err);
            alert("Gagal menyimpan data: " + err.message);
          }
        },

        editDashboard(kodeSatker) {
          const data = this.dashboardData.find(
            (d) => d.kode_satker === kodeSatker
          );
          if (data) {
            this.openModal("dashboard", data);
          }
        },

        async saveTransaksi(event) {
          event.preventDefault();

          const data = {
            tanggal_pembelian: document.getElementById("tglPembelian").value,
            kppn: document.getElementById("kppn").value,
            kode_satker: document.getElementById("kodeSatker").value,
            satuan_kerja: document.getElementById("satker").value,
            pejabat_pengadaan: document.getElementById("pejabat").value,
            produk: document.getElementById("produk").value,
            total_nominal:
              parseFloat(document.getElementById("totalNominal").value) || 0,
            nomor_rekening: document.getElementById("noRekening").value || null,
            nomor_invoice: document.getElementById("noInvoice").value,
            metode_bayar: document.getElementById("metodeBayar").value,
            status_transaksi: document.getElementById("statusTransaksi").value,
            tanggal_deadline:
              document.getElementById("tglDeadline").value || null,
            tanggal_jatuh_tempo:
              document.getElementById("tglJatuhTempo").value || null,
            tanggal_checkout:
              document.getElementById("tglCheckout").value || null,
            tanggal_kirim: document.getElementById("tglKirim").value || null,
            tanggal_terima: document.getElementById("tglTerima").value || null,
            tanggal_bayar: document.getElementById("tglBayar").value || null,
          };

          try {
            console.log("Menyimpan transaksi:", data);

            if (this.currentEdit) {
              const { data: result, error } = await supabaseClient
                .from("tbl_transaksi")
                .update(data)
                .eq("no", this.currentEdit.no)
                .select();

              if (error) throw error;
              console.log("Update transaksi berhasil:", result);
            } else {
              const { data: result, error } = await supabaseClient
                .from("tbl_transaksi")
                .insert([data])
                .select();

              if (error) throw error;
              console.log("Insert transaksi berhasil:", result);
            }

            await this.loadTransaksiData();
            this.calculateSheetProses();
            this.calculateRekapDigipay();
            this.renderAll();
            this.updateStats();
            this.closeModal("transaksi");
            alert("Data transaksi berhasil disimpan!");
          } catch (err) {
            console.error("Error saving transaksi:", err);
            alert("Gagal menyimpan data: " + err.message);
          }
        },

        editTransaksi(id) {
          const data = this.transaksiData.find((t) => t.no === id);
          if (data) {
            this.openModal("transaksi", data);
          }
        },

        async deleteTransaksi(id) {
          if (confirm("Hapus transaksi ini?")) {
            try {
              const { error } = await supabaseClient
                .from("tbl_transaksi")
                .delete()
                .eq("no", id);

              if (error) throw error;

              await this.loadTransaksiData();
              this.calculateSheetProses();
              this.calculateRekapDigipay();
              this.renderAll();
              this.updateStats();
              alert("Data transaksi berhasil dihapus!");
            } catch (err) {
              console.error("Error deleting transaksi:", err);
              alert("Gagal menghapus data: " + err.message);
            }
          }
        },

        prepareWhatsApp(kodeSatker) {
          const satker = this.dashboardData.find(
            (d) => d.kode_satker === kodeSatker
          );
          if (!satker) return;

          const proses = this.sheetProsesData.find(
            (p) => p.kodeSatker === satker.kode_satker
          );

          const message =
            proses && proses.status === "SUDAH"
              ? `Kami memberikan apresiasi kepada ${satker.nama_satker} yang telah mengimplementasikan Digipay.\n\nSampai saat ini telah melakukan ${proses.prosesTransaksi} proses transaksi dan ${proses.transaksi} transaksi berhasil.\n\nMohon terus lakukan optimalisasi digitalisasi pembayaran.`
              : `Berdasarkan monitoring, ${satker.nama_satker} belum mengimplementasikan Digipay.\n\nSesuai Nota Dinas Direktur Pengelolaan Kas Negara, setiap satker ditargetkan minimal 2 transaksi.\n\nHubungi CSO KPPN: 081349358202`;

          document.getElementById("waSatkerName").value = satker.nama_satker;
          document.getElementById("waNumber").value = satker.nomor_wa || "";
          document.getElementById("waMessage").value = message;
          document.getElementById("whatsappModal").classList.add("active");
        },

        sendWhatsApp(event) {
          event.preventDefault();
          const number = document.getElementById("waNumber").value;
          const message = document.getElementById("waMessage").value;

          if (!number) {
            alert("Nomor WhatsApp harus diisi!");
            return;
          }

          window.open(
            `https://wa.me/${number}?text=${encodeURIComponent(message)}`,
            "_blank"
          );
          this.closeModal("whatsapp");
        },

        // ========== FITUR IMPORT EXCEL ==========

        showImportModal(type) {
          this.importType = type;

          // Set judul dan instruksi
          if (type === "satker") {
            document.getElementById("importModalTitle").textContent =
              "Import Data Satker dari Excel";
            document.getElementById("importInstructions").innerHTML = `
                        <p><strong>Kolom yang harus ada (urutan harus sesuai):</strong></p>
                        <ol style="margin: 10px 0; padding-left: 20px;">
                            <li><strong>kode_satker</strong> - Kode Satker (wajib)</li>
                            <li><strong>nama_satker</strong> - Nama Satker (wajib)</li>
                            <li><strong>nominal</strong> - Nominal (angka, opsional)</li>
                            <li><strong>nomor_wa</strong> - Nomor WhatsApp (opsional)</li>
                        </ol>
                        <p style="margin-top: 10px;"><em>Contoh: Baris pertama adalah header, baris kedua dst adalah data</em></p>
                    `;
          } else {
            document.getElementById("importModalTitle").textContent =
              "Import Data Transaksi dari Excel";
            document.getElementById("importInstructions").innerHTML = `
                        <p><strong>Kolom yang harus ada (urutan harus sesuai):</strong></p>
                        <ol style="margin: 10px 0; padding-left: 20px; columns: 2;">
                            <li>tanggal_pembelian</li>
                            <li>kppn</li>
                            <li>kode_satker</li>
                            <li>satuan_kerja</li>
                            <li>pejabat_pengadaan</li>
                            <li>produk</li>
                            <li>total_nominal</li>
                            <li>nomor_rekening</li>
                            <li>nomor_invoice</li>
                            <li>metode_bayar</li>
                            <li>status_transaksi</li>
                            <li>tanggal_deadline</li>
                            <li>tanggal_jatuh_tempo</li>
                            <li>tanggal_checkout</li>
                            <li>tanggal_kirim</li>
                            <li>tanggal_terima</li>
                            <li>tanggal_bayar</li>
                        </ol>
                        <p style="margin-top: 10px;"><em>Format tanggal: YYYY-MM-DD (contoh: 2025-01-15)</em></p>
                    `;
          }

          // Reset form
          document.getElementById("excelFile").value = "";
          document.getElementById("previewContainer").style.display = "none";
          document.getElementById("btnProcessImport").disabled = true;
          this.importData = null;

          document.getElementById("importModal").classList.add("active");
        },

        async readExcelFile(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();

            reader.onload = (e) => {
              try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
                  header: 1,
                });
                resolve(jsonData);
              } catch (error) {
                reject(error);
              }
            };

            reader.onerror = () => reject(new Error("Gagal membaca file"));
            reader.readAsArrayBuffer(file);
          });
        },

        async previewImport() {
          const fileInput = document.getElementById("excelFile");
          const file = fileInput.files[0];

          if (!file) return;

          try {
            const rawData = await this.readExcelFile(file);

            if (rawData.length < 2) {
              alert(
                "File Excel harus memiliki minimal 2 baris (header + data)"
              );
              return;
            }

            // Ambil header dan data
            const headers = rawData[0];
            const dataRows = rawData.slice(1);

            // MAPPING KOLOM - Normalisasi nama kolom
            const normalizeHeader = (header) => {
              if (!header) return "";
              return String(header).toLowerCase().trim().replace(/\s+/g, "_");
            };

            // Buat mapping
            const headerMap = {};
            headers.forEach((header, index) => {
              headerMap[normalizeHeader(header)] = index;
            });

            console.log("Header mapping:", headerMap);

            // Konversi ke format object dengan key yang benar
            this.importData = dataRows
              .filter((row) =>
                row.some(
                  (cell) => cell !== null && cell !== undefined && cell !== ""
                )
              )
              .map((row) => {
                const obj = {};

                // Untuk setiap kolom yang kita butuhkan, cari di header
                const columnMappings =
                  this.importType === "satker"
                    ? {
                        kode_satker: ["kode_satker", "kode", "kodesatker"],
                        nama_satker: [
                          "nama_satker",
                          "satker",
                          "nama",
                          "namasatker",
                          "satuan_kerja",
                        ],
                        nominal: ["nominal", "up_rm", "uprm", "uang"],
                        nomor_wa: [
                          "nomor_wa",
                          "wa",
                          "whatsapp",
                          "no_wa",
                          "nowa",
                        ],
                      }
                    : {
                        tanggal_pembelian: [
                          "tanggal_pembelian",
                          "tgl_pembelian",
                          "tanggal",
                          "tglpembelian",
                        ],
                        kppn: ["kppn"],
                        kode_satker: ["kode_satker", "kode", "kodesatker"],
                        satuan_kerja: [
                          "satuan_kerja",
                          "satker",
                          "nama_satker",
                          "namasatker",
                        ],
                        pejabat_pengadaan: [
                          "pejabat_pengadaan",
                          "pejabat",
                          "pp",
                          "pejabatpengadaan",
                        ],
                        produk: ["produk", "barang"],
                        total_nominal: [
                          "total_nominal",
                          "nominal",
                          "total",
                          "totalnominal",
                        ],
                        nomor_rekening: [
                          "nomor_rekening",
                          "no_rekening",
                          "rekening",
                          "norek",
                          "no_rek",
                        ],
                        nomor_invoice: [
                          "nomor_invoice",
                          "no_invoice",
                          "invoice",
                          "noinvoice",
                        ],
                        metode_bayar: [
                          "metode_bayar",
                          "metode",
                          "metodebayar",
                          "cara_bayar",
                        ],
                        status_transaksi: [
                          "status_transaksi",
                          "status",
                          "statustransaksi",
                        ],
                        tanggal_deadline: [
                          "tanggal_deadline",
                          "tgl_deadline",
                          "deadline",
                        ],
                        tanggal_jatuh_tempo: [
                          "tanggal_jatuh_tempo",
                          "tgl_jatuh_tempo",
                          "jatuh_tempo",
                          "jatuhtempo",
                        ],
                        tanggal_checkout: [
                          "tanggal_checkout",
                          "tgl_checkout",
                          "checkout",
                        ],
                        tanggal_kirim: [
                          "tanggal_kirim",
                          "tgl_kirim",
                          "tglkirim",
                        ],
                        tanggal_terima: [
                          "tanggal_terima",
                          "tgl_terima",
                          "tglterima",
                        ],
                        tanggal_bayar: [
                          "tanggal_bayar",
                          "tgl_bayar",
                          "tglbayar",
                        ],
                      };

                // Cari nilai untuk setiap kolom
                Object.keys(columnMappings).forEach((targetKey) => {
                  const possibleHeaders = columnMappings[targetKey];

                  for (let possibleHeader of possibleHeaders) {
                    const normalizedPossible = normalizeHeader(possibleHeader);
                    if (headerMap[normalizedPossible] !== undefined) {
                      obj[targetKey] = row[headerMap[normalizedPossible]];
                      break;
                    }
                  }
                });

                return obj;
              });

            console.log("Mapped data sample:", this.importData[0]);

            // Validasi: cek apakah kolom wajib ada
            if (this.importType === "satker") {
              const hasRequired =
                this.importData[0].kode_satker &&
                this.importData[0].nama_satker;
              if (!hasRequired) {
                alert(
                  'Kolom wajib tidak ditemukan!\n\nPastikan file Excel memiliki kolom:\n- kode_satker (atau "kode")\n- nama_satker (atau "satker" / "nama")'
                );
                return;
              }
            } else {
              const hasRequired =
                this.importData[0].tanggal_pembelian &&
                this.importData[0].kode_satker &&
                this.importData[0].satuan_kerja;
              if (!hasRequired) {
                alert(
                  'Kolom wajib tidak ditemukan!\n\nPastikan file Excel memiliki kolom:\n- tanggal_pembelian\n- kode_satker\n- satuan_kerja (atau "satker")'
                );
                return;
              }
            }

            // Tampilkan preview 5 baris pertama
            const preview = this.importData.slice(0, 5);
            const previewTable = document.getElementById("previewTable");

            // Gunakan key dari object pertama sebagai header
            const displayHeaders = Object.keys(this.importData[0]);

            let tableHTML = "<thead><tr>";
            displayHeaders.forEach((h) => {
              tableHTML += `<th style="background: #2563eb; color: white; padding: 8px; font-size: 11px;">${h}</th>`;
            });
            tableHTML += "</tr></thead><tbody>";

            preview.forEach((row) => {
              tableHTML += "<tr>";
              displayHeaders.forEach((h) => {
                let value = row[h] || "-";
                if (
                  typeof value === "number" &&
                  value > 40000 &&
                  value < 50000
                ) {
                  // Kemungkinan Excel date serial
                  const date = new Date((value - 25569) * 86400 * 1000);
                  value = date.toISOString().split("T")[0];
                }
                tableHTML += `<td style="border: 1px solid #e2e8f0; padding: 8px; font-size: 11px;">${value}</td>`;
              });
              tableHTML += "</tr>";
            });
            tableHTML += "</tbody>";

            previewTable.innerHTML = tableHTML;
            document.getElementById("previewContainer").style.display = "block";

            // Tampilkan info lebih detail
            const infoHTML = `
                        <strong style="color: #10b981;">‚úì ${this.importData.length} baris data siap diimport.</strong><br>
                        Menampilkan ${preview.length} baris pertama sebagai preview.<br>
                        <span style="color: #f59e0b;">‚ö†Ô∏è Periksa data sebelum import!</span>
                    `;
            document.getElementById("previewInfo").innerHTML = infoHTML;
            document.getElementById("btnProcessImport").disabled = false;
          } catch (error) {
            console.error("Error reading Excel:", error);
            alert(
              "Gagal membaca file Excel: " +
                error.message +
                "\n\nPastikan file adalah format Excel yang valid (.xlsx atau .xls)"
            );
          }
        },

        async processImport() {
          if (!this.importData || this.importData.length === 0) {
            alert("Tidak ada data untuk diimport");
            return;
          }

          const confirmed = confirm(
            `Import ${this.importData.length} data ${this.importType}?`
          );
          if (!confirmed) return;

          document.getElementById("btnProcessImport").disabled = true;
          document.getElementById("btnProcessImport").innerHTML =
            "<span>‚è≥</span> Memproses...";

          try {
            let successCount = 0;
            let errorCount = 0;
            const errors = [];

            if (this.importType === "satker") {
              // Import Satker
              for (let i = 0; i < this.importData.length; i++) {
                const row = this.importData[i];

                try {
                  // Validasi data wajib
                  if (!row.kode_satker || !row.nama_satker) {
                    throw new Error("Kode satker dan nama satker harus diisi");
                  }

                  const data = {
                    kode_satker: String(row.kode_satker).trim(),
                    nama_satker: String(row.nama_satker).trim(),
                    nominal: parseFloat(row.nominal) || 0,
                    nomor_wa: row.nomor_wa ? String(row.nomor_wa).trim() : null,
                  };

                  // Cek duplikat
                  const { data: existing } = await supabaseClient
                    .from("tbl_satker")
                    .select("kode_satker")
                    .eq("kode_satker", data.kode_satker)
                    .maybeSingle();

                  if (existing) {
                    // Update jika sudah ada
                    await supabaseClient
                      .from("tbl_satker")
                      .update(data)
                      .eq("kode_satker", data.kode_satker);
                  } else {
                    // Insert jika baru
                    await supabaseClient.from("tbl_satker").insert([data]);
                  }

                  successCount++;
                } catch (err) {
                  errorCount++;
                  errors.push(`Baris ${i + 2}: ${err.message}`);
                }
              }
            } else {
              // Import Transaksi
              for (let i = 0; i < this.importData.length; i++) {
                const row = this.importData[i];

                try {
                  // Helper function untuk konversi tanggal Excel
                  const parseExcelDate = (value) => {
                    if (!value) return null;

                    // Jika sudah format string tanggal
                    if (typeof value === "string") {
                      // Coba parse berbagai format
                      const formats = [
                        /^\d{4}-\d{2}-\d{2}$/, // 2025-01-15
                        /^\d{2}\/\d{2}\/\d{4}$/, // 15/01/2025
                        /^\d{1,2}-\w{3}-\d{2}$/, // 15-Jan-25
                      ];

                      // Jika format YYYY-MM-DD, langsung return
                      if (formats[0].test(value)) return value;

                      // Coba parse tanggal lain
                      const date = new Date(value);
                      if (!isNaN(date.getTime())) {
                        return date.toISOString().split("T")[0];
                      }
                    }

                    // Jika angka Excel serial date (ex: 45678)
                    if (typeof value === "number") {
                      const date = new Date((value - 25569) * 86400 * 1000);
                      return date.toISOString().split("T")[0];
                    }

                    return null;
                  };

                  // Validasi data wajib
                  if (
                    !row.tanggal_pembelian ||
                    !row.kode_satker ||
                    !row.satuan_kerja
                  ) {
                    throw new Error(
                      "Tanggal pembelian, kode satker, dan satuan kerja harus diisi"
                    );
                  }

                  const data = {
                    tanggal_pembelian: parseExcelDate(row.tanggal_pembelian),
                    kppn: row.kppn
                      ? String(row.kppn).trim()
                      : "KPPN PEKALONGAN",
                    kode_satker: String(row.kode_satker).trim(),
                    satuan_kerja: String(row.satuan_kerja).trim(),
                    pejabat_pengadaan: row.pejabat_pengadaan
                      ? String(row.pejabat_pengadaan).trim()
                      : null,
                    produk: row.produk ? String(row.produk).trim() : null,
                    total_nominal:
                      parseFloat(
                        String(row.total_nominal).replace(/[^\d.-]/g, "")
                      ) || 0,
                    nomor_rekening: row.nomor_rekening
                      ? String(row.nomor_rekening).trim()
                      : null,
                    nomor_invoice: row.nomor_invoice
                      ? String(row.nomor_invoice).trim()
                      : null,
                    metode_bayar: row.metode_bayar
                      ? String(row.metode_bayar).trim()
                      : "VA",
                    status_transaksi: row.status_transaksi
                      ? String(row.status_transaksi).trim()
                      : "Pending",
                    tanggal_deadline: parseExcelDate(row.tanggal_deadline),
                    tanggal_jatuh_tempo: parseExcelDate(
                      row.tanggal_jatuh_tempo
                    ),
                    tanggal_checkout: parseExcelDate(row.tanggal_checkout),
                    tanggal_kirim: parseExcelDate(row.tanggal_kirim),
                    tanggal_terima: parseExcelDate(row.tanggal_terima),
                    tanggal_bayar: parseExcelDate(row.tanggal_bayar),
                  };

                  // Log untuk debugging
                  console.log(`Processing row ${i + 2}:`, data);

                  await supabaseClient.from("tbl_transaksi").insert([data]);

                  successCount++;
                } catch (err) {
                  errorCount++;
                  console.error(`Error on row ${i + 2}:`, err, row);
                  errors.push(`Baris ${i + 2}: ${err.message}`);
                }
              }
            }

            // Refresh data
            await this.loadDashboardData();
            await this.loadTransaksiData();
            this.calculateSheetProses();
            this.calculateRekapDigipay();
            this.renderAll();
            this.updateStats();

            // Tampilkan hasil
            let message = `Import selesai!\n\nBerhasil: ${successCount}\nGagal: ${errorCount}`;
            if (errors.length > 0 && errors.length <= 5) {
              message += "\n\nError:\n" + errors.join("\n");
            } else if (errors.length > 5) {
              message +=
                "\n\nError (5 pertama):\n" + errors.slice(0, 5).join("\n");
            }

            alert(message);
            this.closeModal("import");
          } catch (error) {
            console.error("Error processing import:", error);
            alert("Gagal memproses import: " + error.message);
          } finally {
            document.getElementById("btnProcessImport").disabled = false;
            document.getElementById("btnProcessImport").innerHTML =
              "<span>‚¨ÜÔ∏è</span> Proses Import";
          }
        },
        printProses() {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF("landscape");

          // Header
          doc.setFontSize(16);
          doc.setFont(undefined, "bold");
          doc.text("LAPORAN PROSES TRANSAKSI DIGIPAY", 148, 15, {
            align: "center",
          });

          doc.setFontSize(12);
          doc.setFont(undefined, "normal");
          doc.text("KPPN Pekalongan", 148, 22, { align: "center" });

          doc.setFontSize(10);
          const today = new Date().toLocaleDateString("id-ID", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          });
          doc.text(`Tanggal Cetak: ${today}`, 148, 28, { align: "center" });

          // Line separator
          doc.setLineWidth(0.5);
          doc.line(14, 32, 282, 32);

          // Filter data
          const data = this.getFilteredData();

          // Summary statistics
          const sudah = data.filter((d) => d.status === "SUDAH").length;
          const belum = data.filter((d) => d.status === "BELUM").length;
          const totalProses = data.reduce(
            (sum, d) => sum + d.prosesTransaksi,
            0
          );
          const totalTransaksi = data.reduce((sum, d) => sum + d.transaksi, 0);
          const totalVA = data.reduce((sum, d) => sum + d.vaTerbayar, 0);

          doc.setFontSize(9);
          doc.text(
            `Total Satker: ${data.length} | Sudah Implementasi: ${sudah} | Belum Implementasi: ${belum}`,
            14,
            38
          );
          doc.text(
            `Total Proses: ${totalProses} | Total Transaksi: ${totalTransaksi} | Total VA Terbayar: ${totalVA}`,
            14,
            43
          );

          // Table
          const tableData = data.map((item, index) => [
            index + 1,
            item.kodeSatker,
            item.namaSatker,
            item.status,
            item.prosesTransaksi,
            item.transaksi,
            item.vaTerbayar,
          ]);

          doc.autoTable({
            startY: 48,
            head: [
              [
                "No",
                "Kode",
                "Nama Satker",
                "Status",
                "Proses",
                "Transaksi",
                "VA Terbayar",
              ],
            ],
            body: tableData,
            theme: "grid",
            headStyles: {
              fillColor: [30, 64, 175],
              fontSize: 9,
              fontStyle: "bold",
              halign: "center",
            },
            bodyStyles: {
              fontSize: 8,
              cellPadding: 3,
            },
            columnStyles: {
              0: { halign: "center", cellWidth: 12 },
              1: { halign: "center", cellWidth: 25 },
              2: { cellWidth: 100 },
              3: { halign: "center", cellWidth: 25 },
              4: { halign: "center", cellWidth: 25 },
              5: { halign: "center", cellWidth: 25 },
              6: { halign: "center", cellWidth: 30 },
            },
            didDrawCell: (data) => {
              if (data.column.index === 3 && data.section === "body") {
                const status = data.cell.raw;
                if (status === "SUDAH") {
                  doc.setFillColor(16, 185, 129);
                } else {
                  doc.setFillColor(239, 68, 68);
                }
                doc.rect(
                  data.cell.x,
                  data.cell.y,
                  data.cell.width,
                  data.cell.height,
                  "F"
                );
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(8);
                doc.text(
                  status,
                  data.cell.x + data.cell.width / 2,
                  data.cell.y + data.cell.height / 2,
                  {
                    align: "center",
                    baseline: "middle",
                  }
                );
                doc.setTextColor(0, 0, 0);
              }
            },
          });

          // Footer
          const pageCount = doc.internal.getNumberOfPages();
          for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.text(`Halaman ${i} dari ${pageCount}`, 148, 200, {
              align: "center",
            });
            doc.text("Dicetak dari Sistem Monitoring KPPN Digipay", 148, 205, {
              align: "center",
            });
          }

          doc.save(
            `Laporan-Proses-${new Date().toISOString().split("T")[0]}.pdf`
          );
        },

        printRekap() {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF("landscape");

          // Header
          doc.setFontSize(16);
          doc.setFont(undefined, "bold");
          doc.text("LAPORAN REKAP DIGIPAY", 148, 15, { align: "center" });

          doc.setFontSize(12);
          doc.setFont(undefined, "normal");
          doc.text("KPPN Pekalongan", 148, 22, { align: "center" });

          doc.setFontSize(10);
          const today = new Date().toLocaleDateString("id-ID", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          });
          doc.text(`Tanggal Cetak: ${today}`, 148, 28, { align: "center" });

          // Line separator
          doc.setLineWidth(0.5);
          doc.line(14, 32, 282, 32);

          // Filter data
          const data = this.getFilteredData();

          // Summary statistics
          const sudah = data.filter((d) => d.status === "SUDAH").length;
          const belum = data.filter((d) => d.status === "BELUM").length;
          const totalNominal = data.reduce((sum, d) => sum + (d.upRM || 0), 0);
          const totalProses = data.reduce(
            (sum, d) => sum + d.prosesTransaksi,
            0
          );
          const totalVA = data.reduce((sum, d) => sum + d.vaTerbayar, 0);

          doc.setFontSize(9);
          doc.text(
            `Total Satker: ${
              data.length
            } | Sudah: ${sudah} | Belum: ${belum} | Total Nominal: Rp ${totalNominal.toLocaleString(
              "id-ID"
            )}`,
            14,
            38
          );
          doc.text(
            `Total Proses: ${totalProses} | Total VA Terbayar: ${totalVA}`,
            14,
            43
          );

          // Table
          const tableData = data.map((item) => [
            item.no,
            item.kodeSatker,
            item.namaSatker,
            `Rp ${(item.upRM || 0).toLocaleString("id-ID")}`,
            item.prosesTransaksi,
            item.vaTerbayar,
            item.transaksiKuitansi,
            item.status,
            item.keterangan || "-",
          ]);

          doc.autoTable({
            startY: 48,
            head: [
              [
                "No",
                "Kode",
                "Satker",
                "Nominal",
                "Proses",
                "VA",
                "Transaksi",
                "Status",
                "Keterangan",
              ],
            ],
            body: tableData,
            theme: "grid",
            headStyles: {
              fillColor: [30, 64, 175],
              fontSize: 8,
              fontStyle: "bold",
              halign: "center",
            },
            bodyStyles: {
              fontSize: 7,
              cellPadding: 2,
            },
            columnStyles: {
              0: { halign: "center", cellWidth: 10 },
              1: { halign: "center", cellWidth: 20 },
              2: { cellWidth: 60 },
              3: { halign: "right", cellWidth: 30 },
              4: { halign: "center", cellWidth: 15 },
              5: { halign: "center", cellWidth: 15 },
              6: { halign: "center", cellWidth: 20 },
              7: { halign: "center", cellWidth: 20 },
              8: { cellWidth: 52 },
            },
            didDrawCell: (data) => {
              if (data.column.index === 7 && data.section === "body") {
                const status = data.cell.raw;
                if (status === "SUDAH") {
                  doc.setFillColor(16, 185, 129);
                } else {
                  doc.setFillColor(239, 68, 68);
                }
                doc.rect(
                  data.cell.x,
                  data.cell.y,
                  data.cell.width,
                  data.cell.height,
                  "F"
                );
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(7);
                doc.text(
                  status,
                  data.cell.x + data.cell.width / 2,
                  data.cell.y + data.cell.height / 2,
                  {
                    align: "center",
                    baseline: "middle",
                  }
                );
                doc.setTextColor(0, 0, 0);
              }
            },
          });

          // Footer
          const pageCount = doc.internal.getNumberOfPages();
          for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.text(`Halaman ${i} dari ${pageCount}`, 148, 200, {
              align: "center",
            });
            doc.text("Dicetak dari Sistem Monitoring KPPN Digipay", 148, 205, {
              align: "center",
            });
          }

          doc.save(
            `Laporan-Rekap-Digipay-${
              new Date().toISOString().split("T")[0]
            }.pdf`
          );
        },

        exportProsesExcel() {
          // Filter data yang akan diexport
          const data = this.getFilteredData();

          // Siapkan data untuk Excel
          const excelData = data.map((item, index) => ({
            No: index + 1,
            "Kode Satker": item.kodeSatker,
            "Nama Satker": item.namaSatker,
            Status: item.status,
            "Proses Transaksi": item.prosesTransaksi,
            Transaksi: item.transaksi,
            "VA Terbayar": item.vaTerbayar,
          }));

          // Buat worksheet
          const ws = XLSX.utils.json_to_sheet(excelData);

          // Set lebar kolom
          ws["!cols"] = [
            { wch: 5 }, // No
            { wch: 15 }, // Kode Satker
            { wch: 40 }, // Nama Satker
            { wch: 12 }, // Status
            { wch: 18 }, // Proses Transaksi
            { wch: 12 }, // Transaksi
            { wch: 15 }, // VA Terbayar
          ];

          // Buat workbook
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Proses Transaksi");

          // Tambahkan sheet summary
          const summary = [
            ["LAPORAN PROSES TRANSAKSI DIGIPAY"],
            ["KPPN Pekalongan"],
            ["Tanggal: " + new Date().toLocaleDateString("id-ID")],
            [""],
            ["Total Satker", data.length],
            [
              "Sudah Implementasi",
              data.filter((d) => d.status === "SUDAH").length,
            ],
            [
              "Belum Implementasi",
              data.filter((d) => d.status === "BELUM").length,
            ],
            [
              "Total Proses Transaksi",
              data.reduce((sum, d) => sum + d.prosesTransaksi, 0),
            ],
            ["Total Transaksi", data.reduce((sum, d) => sum + d.transaksi, 0)],
            [
              "Total VA Terbayar",
              data.reduce((sum, d) => sum + d.vaTerbayar, 0),
            ],
          ];

          const wsSummary = XLSX.utils.aoa_to_sheet(summary);
          wsSummary["!cols"] = [{ wch: 25 }, { wch: 15 }];
          XLSX.utils.book_append_sheet(wb, wsSummary, "Summary");

          // Download file
          const fileName = `Laporan-Proses-${
            new Date().toISOString().split("T")[0]
          }.xlsx`;
          XLSX.writeFile(wb, fileName);
        },

        exportRekapExcel() {
          // Filter data yang akan diexport
          const data = this.getFilteredData();

          // Siapkan data untuk Excel
          const excelData = data.map((item) => ({
            No: item.no,
            "Kode Satker": item.kodeSatker,
            "Nama Satker": item.namaSatker,
            Nominal: item.upRM || 0,
            "Proses Transaksi": item.prosesTransaksi,
            "VA Terbayar": item.vaTerbayar,
            "Transaksi VA": item.transaksiKuitansi,
            Status: item.status,
            Keterangan: item.keterangan || "-",
          }));

          // Buat worksheet
          const ws = XLSX.utils.json_to_sheet(excelData);

          // Set lebar kolom
          ws["!cols"] = [
            { wch: 5 }, // No
            { wch: 15 }, // Kode Satker
            { wch: 40 }, // Nama Satker
            { wch: 15 }, // Nominal
            { wch: 18 }, // Proses Transaksi
            { wch: 15 }, // VA Terbayar
            { wch: 15 }, // Transaksi VA
            { wch: 12 }, // Status
            { wch: 35 }, // Keterangan
          ];

          // Format kolom nominal sebagai currency
          const range = XLSX.utils.decode_range(ws["!ref"]);
          for (let row = 1; row <= range.e.r; row++) {
            const cellAddress = XLSX.utils.encode_cell({ r: row, c: 3 }); // Kolom D (Nominal)
            if (ws[cellAddress] && typeof ws[cellAddress].v === "number") {
              ws[cellAddress].z = "#,##0";
            }
          }

          // Buat workbook
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Rekap Digipay");

          // Tambahkan sheet summary
          const totalNominal = data.reduce((sum, d) => sum + (d.upRM || 0), 0);
          const summary = [
            ["LAPORAN REKAP DIGIPAY"],
            ["KPPN Pekalongan"],
            ["Tanggal: " + new Date().toLocaleDateString("id-ID")],
            [""],
            ["Total Satker", data.length],
            [
              "Sudah Implementasi",
              data.filter((d) => d.status === "SUDAH").length,
            ],
            [
              "Belum Implementasi",
              data.filter((d) => d.status === "BELUM").length,
            ],
            ["Total Nominal", totalNominal],
            [
              "Total Proses Transaksi",
              data.reduce((sum, d) => sum + d.prosesTransaksi, 0),
            ],
            [
              "Total VA Terbayar",
              data.reduce((sum, d) => sum + d.vaTerbayar, 0),
            ],
            [
              "Total Transaksi VA",
              data.reduce((sum, d) => sum + d.transaksiKuitansi, 0),
            ],
          ];

          const wsSummary = XLSX.utils.aoa_to_sheet(summary);
          wsSummary["!cols"] = [{ wch: 25 }, { wch: 20 }];
          XLSX.utils.book_append_sheet(wb, wsSummary, "Summary");

          // Download file
          const fileName = `Laporan-Rekap-Digipay-${
            new Date().toISOString().split("T")[0]
          }.xlsx`;
          XLSX.writeFile(wb, fileName);
        },
      };

      document.addEventListener("DOMContentLoaded", () => {
        console.log("DOM loaded, starting app...");
        app.init();
      });
    </script>
  </body>
</html>
